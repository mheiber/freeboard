# Fix Markdown Syntax Highlighting — Use TextMate Grammars

## Context

The Monaco Editor (v0.45.0) in Freeboard has broken Markdown syntax highlighting:
1. **Apostrophes break highlighting** — "doesn't" causes everything after `'` to turn green (HTML tag state treats `'` as an attribute delimiter and leaks across lines)
2. **Common words colored as keywords** — "from", "and", "to", "as" appear colored (embedded language tokenizer leaks from code blocks)

The built-in Monarch grammar for markdown hasn't been fixed upstream (same in v0.55.1). Instead of writing a custom parser, we'll use **TextMate grammars** — the same battle-tested grammar system that VS Code uses for all its syntax highlighting.

## Approach

1. **Update Monaco Editor** from v0.45.0 to v0.55.1
2. **Add TextMate grammar support** via `vscode-textmate` + `vscode-oniguruma` (the standard libraries for this)
3. **Use VS Code's markdown TextMate grammar** (`markdown.tmLanguage.json`)
4. **Wire it into Monaco** using `monaco.languages.setTokensProvider()`

This replaces the broken Monarch tokenizer with VS Code's own markdown grammar — no custom parser needed.

## Files to Modify/Add

### Modified
- **`Freeboard/Resources/MonacoEditor/editor.html`** — Add TextMate initialization and grammar loading
- **`Freeboard/MonacoEditorView.swift`** — Add `.wasm` MIME type to `MonacoSchemeHandler`

### New files (in `Freeboard/Resources/MonacoEditor/`)
- **`textmate-bundle.js`** — Bundled `vscode-textmate` + `vscode-oniguruma` (generated by build script)
- **`onig.wasm`** — Oniguruma regex engine WASM binary (from `vscode-oniguruma` npm package)
- **`markdown.tmLanguage.json`** — VS Code's markdown TextMate grammar (from `microsoft/vscode` repo, MIT license)

### New build script
- **`scripts/setup-textmate.sh`** — One-time script to download/bundle the dependencies

## Implementation Steps

### Step 1: Create `scripts/setup-textmate.sh`

```bash
#!/bin/bash
# Install deps, bundle JS, copy WASM and grammar
cd "$(mktemp -d)"
npm init -y
npm install vscode-textmate vscode-oniguruma
npx esbuild --bundle --format=iife --global-name=TextMateBundle \
  --outfile=textmate-bundle.js entry.js
cp node_modules/vscode-oniguruma/release/onig.wasm $RESOURCES/
cp textmate-bundle.js $RESOURCES/
# Download markdown grammar from VS Code GitHub
curl -o $RESOURCES/markdown.tmLanguage.json \
  https://raw.githubusercontent.com/microsoft/vscode/main/extensions/markdown-basics/syntaxes/markdown.tmLanguage.json
```

The `entry.js` file re-exports both libraries:
```javascript
module.exports = {
  vsctm: require('vscode-textmate'),
  oniguruma: require('vscode-oniguruma')
};
```

### Step 2: Add WASM MIME type to `MonacoSchemeHandler`

In `MonacoEditorView.swift`, add to the `mimeType(for:)` switch:
```swift
case "wasm": return "application/wasm"
```

### Step 3: Update `editor.html`

Add script tags to load the TextMate bundle:
```html
<script src="textmate-bundle.js"></script>
```

In `initEditor()`, after `defineTheme` and before `editor.create`:

1. **Load WASM**: Fetch `onig.wasm` via the custom URL scheme, initialize oniguruma
2. **Create TextMate Registry**: With `loadGrammar` callback that fetches `markdown.tmLanguage.json`
3. **Load the grammar**: `registry.loadGrammar('text.html.markdown')`
4. **Create ITokensProvider**: Implement `getInitialState()` and `tokenize(line, state)` that delegate to the TextMate grammar
5. **Register**: `monaco.languages.setTokensProvider('markdown', provider)`

Key integration code pattern:
```javascript
// State wrapper for Monaco
class TMState {
  constructor(ruleStack) { this._ruleStack = ruleStack; }
  clone() { return new TMState(this._ruleStack); }
  equals(other) { return other instanceof TMState && other._ruleStack === this._ruleStack; }
}

// Token provider
monaco.languages.setTokensProvider('markdown', {
  getInitialState: () => new TMState(vsctm.INITIAL),
  tokenize: (line, state) => {
    const r = grammar.tokenizeLine(line, state._ruleStack);
    return {
      tokens: r.tokens.map(t => ({
        startIndex: t.startIndex,
        scopes: t.scopes[t.scopes.length - 1] // most specific scope
      })),
      endState: new TMState(r.ruleStack)
    };
  }
});
```

### Step 4: Update theme rules

Add TextMate scope mappings to the `freeboard-dark` theme:
```javascript
rules: [
  { token: 'markup.heading', foreground: '569cd6', fontStyle: 'bold' },
  { token: 'entity.name.section', foreground: '569cd6' },
  { token: 'punctuation.definition.heading', foreground: '569cd6' },
  { token: 'markup.bold', fontStyle: 'bold' },
  { token: 'markup.italic', fontStyle: 'italic' },
  { token: 'markup.inline.raw', foreground: 'ce9178' },
  { token: 'markup.fenced_code', foreground: 'ce9178' },
  { token: 'string.other.link', foreground: '4ec9b0' },
  { token: 'markup.underline.link', foreground: '4ec9b0' },
  { token: 'comment.block.html', foreground: '6a9955' },
  { token: 'punctuation.definition.list', foreground: '569cd6' },
  { token: 'meta.separator', foreground: '569cd6' },
  { token: 'markup.quote', foreground: '6a9955' },
]
```

### Step 5: Update Monaco Editor to v0.55.1

Download latest Monaco distribution and replace files in `Resources/MonacoEditor/vs/`. Verify `monaco-vim.js` compatibility. Keep the language files in `basic-languages/` (they're still used for non-markdown languages).

## Verification

Build and launch the app, then test in the editor:

1. `"I don't think it doesn't work"` — apostrophes don't break colors
2. `"It's clear he'd've gone"` — uniform default text color
3. `# H1` through `###### H6` — headings colored
4. `**bold**`, `*italic*`, `__bold__`, `_italic_` — styled correctly
5. Fenced code blocks — visually distinct, no keyword leaking after block closes
6. `"words from and to"` after a code block — NOT colored as Python keywords
7. Tables, links, blockquotes, lists — visually correct
8. `<!-- comment -->` — colored as comment
9. Open the app's Web Inspector (Develop menu > Freeboard) to check for JS errors
